- name: "‚úÖ Crear organizaci√≥n en VMware Cloud Director (CloudAPI)"
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs"
    method: POST
    headers:
      Accept: "application/json;version={{ vcd.api_version }},application/*+json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ vcd.orgFullName }}"
      displayName: "{{ vcd.orgFullName }}"
      isEnabled: true
      description: "Organizaci√≥n creada autom√°ticamente por Ansible"
    # Aceptamos 400 para poder analizar su contenido en failed_when
    status_code: [200, 201, 409, 400] 
    validate_certs: "{{ vcd.verify_ssl }}"
  register: org_create
  failed_when:
    - org_create.status == 400 and org_create.json.minorErrorCode != 'DUPLICATE_NAME'
    # Fallo
    - org_create.status >= 500
  changed_when: org_create.status == 201


- name: "‚öôÔ∏è Establecer si la organizaci√≥n ya exist√≠a (Idempotencia)"
  ansible.builtin.set_fact:
    org_existed: >
      {{ (org_create.status == 409) or 
         (org_create.status == 400 and org_create.json.minorErrorCode == 'DUPLICATE_NAME') }}

- name: "üîç Mostrar resultado de creaci√≥n de la organizaci√≥n"
  ansible.builtin.debug:
    msg: >
      {% if org_create.status == 201 %}
        ‚úÖ Organizaci√≥n '{{ vcd.orgFullName }}' creada correctamente.
      {% elif org_existed %}
        ‚ö†Ô∏è La organizaci√≥n '{{ vcd.orgFullName }}' ya existe (Idempotente).
      {% else %}
        ‚ùå Error inesperado al crear la organizaci√≥n: {{ org_create }}
      {% endif %}
