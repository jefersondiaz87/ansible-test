# ===========================================================
# CREACI√ìN DE EDGE GATEWAY (CloudAPI 1.0.0)
# ===========================================================

# -----------------------------------------------------------
# Construir el nombre del Edge Gateway igual que en vRO
# -----------------------------------------------------------
- name: Construir nombre del Edge Gateway
  ansible.builtin.set_fact:
    locationPrefix: "{{ vcd.orgVdcName.split('-')[0] }}"
    edgeGatewayName: "{{ vcd.orgVdcName.split('-')[0] }}-{{ vcd.orgFullName }}-{{ vcd.networkType }}"
    externalNetworkName: "{{ vcd.orgVdcName.split('-')[0] }}-{{ vcd.networkType }}-01"
  delegate_to: localhost

- name: Mostrar nombre calculado del Edge Gateway
  ansible.builtin.debug:
    msg:
      - "üìç locationPrefix: {{ locationPrefix }}"
      - "üì° Edge Gateway generado: {{ edgeGatewayName }}"
      - "üåê External Network esperada: {{ externalNetworkName }}"

# ===========================================================
# VALIDAR SI EL EDGE GATEWAY YA EXISTE
# ===========================================================
- name: Validar si el Edge Gateway ya existe (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/edgeGateways?filter=name=={{ edgeGatewayName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    validate_certs: "{{ vcd.verify_ssl }}"
  register: edge_check
  failed_when: edge_check.status not in [200]

- name: Determinar si el Edge Gateway ya existe
  ansible.builtin.set_fact:
    edge_exists: "{{ ('values' in edge_check.json) and (edge_check.json['values'] | length > 0) }}"

- name: Mostrar estado del Edge Gateway
  ansible.builtin.debug:
    msg:
      - "üí° Edge Gateway buscado: {{ edgeGatewayName }}"
      - "üìã Resultado: {{ (edge_check.json['values'] | length) if ('values' in edge_check.json) else 0 }}"
      - "üîç Estado: {{ 'YA EXISTE ‚úÖ' if edge_exists else 'NO EXISTE üöÄ Se proceder√° a crear' }}"

# ===========================================================
# MOSTRAR VARIABLES DE ENTRADA ANTES DE PowerCLI
# ===========================================================
- name: Mostrar variables antes de ejecutar PowerCLI
  ansible.builtin.debug:
    msg:
      - "üì° Servidor VCD: {{ vcd.host }}"
      - "üë§ Usuario: {{ vcd.user }}"
      - "üèóÔ∏è  Org VDC: {{ vcd.orgVdcName }}"
      - "üèóÔ∏è  EdgeName: {{ edgeGatewayName }}"
      - "üèóÔ∏è  externalNetworkName: {{ externalNetworkName }}"
      - "üìù Descripci√≥n: Organizaci√≥n {{ vcd.orgFullName }} - creado por AWX"
  delegate_to: localhost
  connection: local

# ===========================================================
# üöÄ CREAR EDGE GATEWAY VIA POWERSHELL (PowerCLI 13.3)
# ===========================================================
- name: Ejecutar script PowerCLI para crear Edge Gateway
  ansible.builtin.win_shell: |
    Write-Host "=== Iniciando creaci√≥n de Edge Gateway (PowerCLI 13.3) ==="
    Write-Host "Servidor: {{ vcd.host }}"
    Write-Host "Usuario: {{ vcd.user }}"
    Write-Host "OrgVdc: {{ vcd.orgVdcName }}"
    Write-Host "EdgeName: {{ edgeGatewayName }}"
    Write-Host "AccessToken: {{vcd.access_token}}"
    powershell.exe -ExecutionPolicy Bypass -File "D:\Users\Jeferson Diaz\Documents\g6\Ansible\networkedge.ps1" `
      -Server "{{ vcd.host }}" `
      -Username "{{ vcd.user }}" `
      -Password "{{ vcd.password }}" `
      -OrgVdcName "{{ vcd.orgVdcName }}" `
      -EdgeName "{{ edgeGatewayName }}" `
      -ExternalNetworkName "{{ externalNetworkName }}" `
      -AccessToken: "{{vcd.access_token}}"

  vars:
    ansible_connection: winrm
    ansible_host: "100.66.2.151"
    ansible_port: 5985
    ansible_user: "jeferson diaz"
    ansible_password: "Zero.eg9olj12*"
    ansible_winrm_transport: basic
    ansible_winrm_server_cert_validation: ignore
  register: script_result
  delegate_to: win-builder

# ===========================================================
# MOSTRAR RESULTADO DE EJECUCI√ìN
# ===========================================================
- name: Mostrar resultado del script PowerCLI
  ansible.builtin.debug:
    msg:
      - "‚úÖ Ejecuci√≥n completada en PowerCLI"
      - "üìú Salida:"
      - "{{ script_result.stdout_lines }}"

- name: Extraer EDGE_ID y UPLINK_INFO desde salida PowerCLI
  ansible.builtin.set_fact:
    edge_id: >-
      {{ (script_result.stdout_lines | select('search', '^EDGE_ID=') | map('regex_replace', '^EDGE_ID=', '') | list | first | default('')) }}
    uplink_info_raw: >-
      {{ (script_result.stdout_lines | select('search', '^UPLINK_INFO=') | map('regex_replace', '^UPLINK_INFO=', '') | list | first | default('')) }}

- name: Mostrar EDGE_ID y UPLINK_INFO extra√≠dos
  ansible.builtin.debug:
    msg:
      - "EDGE_ID: {{ edge_id }}"
      - "UPLINK_INFO: {{ uplink_info_raw }}"

- name: Separar UPLINK_INFO en variables individuales
  ansible.builtin.set_fact:
    uplink_name: "{{ uplink_info_raw.split(';')[0] }}"
    gateway: "{{ uplink_info_raw.split(';')[1] }}"
    start_ip: "{{ uplink_info_raw.split(';')[2] }}"
    end_ip: "{{ uplink_info_raw.split(';')[3] }}"
  when: uplink_info_raw != ''

- name: Validar que EDGE_ID fue extra√≠do
  ansible.builtin.fail:
    msg: "‚ùå No se pudo extraer EDGE_ID desde la salida del script PowerCLI."
  when: edge_id == ''


- name: Ejecutar script PowerCLI para crear red ruteada (CreateOrgVdcRouteNet)
  ansible.builtin.win_shell: |
    Write-Host "=== Iniciando creaci√≥n de red ruteada ==="
    Write-Host "Servidor: {{ vcd.host }}"
    Write-Host "Usuario: {{ vcd.user }}"
    Write-Host "OrgVdc: {{ vcd.orgVdcName }}"
    Write-Host "EdgeId: {{ edge_id }}"
    Write-Host "NetworkName: {{ uplink_name }}"
    Write-Host "Gateway: {{ gateway }}"
    Write-Host "StartIP: {{ start_ip }}"
    Write-Host "EndIP: {{ end_ip }}"
    Write-Host "AccessToken: {{vcd.access_token}}"
    powershell.exe -ExecutionPolicy Bypass -File "D:\Users\Jeferson Diaz\Documents\g6\Ansible\networkNet.ps1" `
      -Server "{{ vcd.host }}" `
      -Username "{{ vcd.user }}" `
      -Password "{{ vcd.password }}" `
      -OrgVdcName "{{ vcd.orgVdcName }}" `
      -EdgeId "{{ edge_id }}" `
      -NetworkName "{{ uplink_name }}" `
      -Gateway "{{ gateway }}" `
      -StartIP "{{ start_ip }}" `
      -EndIP "{{ end_ip }}"
      -AccessToken: "{{vcd.access_token}}"

  vars:
    ansible_connection: winrm
    ansible_host: "100.66.2.151"
    ansible_port: 5985
    ansible_user: "jeferson diaz"
    ansible_password: "Zero.eg9olj12*"
    ansible_winrm_transport: basic
    ansible_winrm_server_cert_validation: ignore
  register: routed_net_result
  delegate_to: win-builder

- name: Mostrar resultado de creaci√≥n de red ruteada
  ansible.builtin.debug:
    msg:
      - "‚úÖ Red ruteada creada correctamente"
      - "{{ routed_net_result.stdout_lines }}"
  