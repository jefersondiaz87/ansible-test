# ===========================================================
# CREACI√ìN DE EDGE GATEWAY (CloudAPI 1.0.0)
# ===========================================================

# -----------------------------------------------------------
# Construir el nombre del Edge Gateway igual que en vRO
# -----------------------------------------------------------
- name: Construir nombre del Edge Gateway
  ansible.builtin.set_fact:
    locationPrefix: "{{ vcd.orgVdcName.split('-')[0] }}"
    edgeGatewayName: "{{ vcd.orgVdcName.split('-')[0] }}-{{ vcd.orgFullName }}-{{ vcd.networkType }}"
    externalNetworkName: "{{ vcd.orgVdcName.split('-')[0] }}-{{ vcd.networkType }}-01"
  delegate_to: localhost

- name: Mostrar nombre calculado del Edge Gateway
  ansible.builtin.debug:
    msg:
      - "üìç locationPrefix: {{ locationPrefix }}"
      - "üì° Edge Gateway generado: {{ edgeGatewayName }}"
      - "üåê External Network esperada: {{ externalNetworkName }}"

# ===========================================================
# VALIDAR SI EL EDGE GATEWAY YA EXISTE
# ===========================================================
- name: Validar si el Edge Gateway ya existe (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/edgeGateways?filter=name=={{ edgeGatewayName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    validate_certs: "{{ vcd.verify_ssl }}"
  register: edge_check
  failed_when: edge_check.status not in [200]

- name: Determinar si el Edge Gateway ya existe
  ansible.builtin.set_fact:
    edge_exists: "{{ ('values' in edge_check.json) and (edge_check.json['values'] | length > 0) }}"

- name: Mostrar estado del Edge Gateway
  ansible.builtin.debug:
    msg:
      - "üí° Edge Gateway buscado: {{ edgeGatewayName }}"
      - "üìã Resultado: {{ (edge_check.json['values'] | length) if ('values' in edge_check.json) else 0 }}"
      - "üîç Estado: {{ 'YA EXISTE ‚úÖ' if edge_exists else 'NO EXISTE üöÄ Se proceder√° a crear' }}"

# ===========================================================
# MOSTRAR VARIABLES DE ENTRADA ANTES DE PowerCLI
# ===========================================================
- name: Mostrar variables antes de ejecutar PowerCLI
  ansible.builtin.debug:
    msg:
      - "üì° Servidor VCD: {{ vcd.host }}"
      - "üë§ Usuario: {{ vcd.user }}"
      - "üèóÔ∏è  Org VDC: {{ vcd.orgVdcName }}"
      - "üèóÔ∏è  EdgeName: {{ edgeGatewayName }}"
      - "üìù Descripci√≥n: Organizaci√≥n {{ vcd.orgFullName }} - creado por AWX"
  delegate_to: localhost
  connection: local

# ===========================================================
# üöÄ CREAR EDGE GATEWAY VIA POWERSHELL (PowerCLI 13.3)
# ===========================================================
- name: Ejecutar script PowerCLI para crear Edge Gateway
  ansible.builtin.win_shell: |
    Write-Host "=== Iniciando creaci√≥n de Edge Gateway (PowerCLI 13.3) ==="
    Write-Host "Servidor: {{ vcd.host }}"
    Write-Host "Usuario: {{ vcd.user }}"
    Write-Host "OrgVdc: {{ vcd.orgVdcName }}"
    Write-Host "EdgeName: {{ edgeGatewayName }}"
    Write-Host "Script: C:\Users\jeferson.diaz\Documents\WindowsPowerShell\Scripts\edgegateway.ps1"

    powershell.exe -ExecutionPolicy Bypass -File "C:\Users\jeferson.diaz\Documents\WindowsPowerShell\Scripts\network.ps1" `
      -Server "{{ vcd.host }}" `
      -Username "{{ vcd.user }}" `
      -Password "{{ vcd.password }}" `
      -OrgVdcName "{{ vcd.orgVdcName }}" `
      -EdgeName "{{ edgeGatewayName }}" `
      -$Type = "{{ vcd.networkType }}" `
      -ExternalNetworkName "{{ vcd.orgVdcName.split('-')[0] }}"
  register: edge_create_result
  delegate_to: win-builder

# ===========================================================
# 4Ô∏è‚É£ Ejecutar script PowerCLI remoto con log
# ===========================================================
- name: Ejecutar PowerCLI en Windows
  ansible.builtin.win_shell: |
    Write-Host "=== Iniciando ejecucion PowerCLI ==="
    Write-Host "Servidor: {{ vcd.host }}"
    Write-Host "Usuario: {{ vcd.user }}"
    Write-Host "OrgName: {{ vcd.orgFullName }}"
    Write-Host "EdgeName: {{ network_match.name }}"
    powershell.exe -ExecutionPolicy Bypass -File "D:\Users\Jeferson Diaz\Documents\g6\Ansible\network.ps1" `
      -Server "{{ vcd.host }}" `
      -Username "{{ vcd.user }}" `
      -Password "{{ vcd.password }}" `
      -VdcName "{{ vcd.orgVdcName }}" `
      -EdgeName "{{ network_match.name }}" `
      -$Type = "{{ vcd.networkType }}" `
      -Description "Network Edge {{ vcd.orgFullName }} - creado por AWX"

  vars:
    hostvcd: "{{vcd.host}}"
    ansible_connection: winrm
    ansible_host: "100.66.2.151"
    ansible_port: 5985
    ansible_user: "jeferson diaz"
    ansible_password: "Zero.eg9olj12*"
    ansible_winrm_transport: basic
    ansible_winrm_server_cert_validation: ignore
  register: script_result

# ===========================================================
# MOSTRAR RESULTADO DE EJECUCI√ìN
# ===========================================================
- name: Mostrar resultado del script PowerCLI
  ansible.builtin.debug:
    msg:
      - "‚úÖ Ejecuci√≥n completada en PowerCLI"
      - "üìú Salida:"
      - "{{ script_result.stdout_lines }}"
