---
# ===========================================================
# 1. RESOLVER COMPONENTES NECESARIOS (Provider VDC, Network, Storage, Compute)
# ... (Tareas de LECTURA/VALIDACI√ìN - No necesitan rollback) ...
# ===========================================================
- name: Extraer prefijo del Org VDC para b√∫squeda regional
  ansible.builtin.set_fact:
    locationPrefix: "{{ vcd.orgVdcName.split('-')[0] }}"
  delegate_to: localhost
  connection: local

- name: Obtener ID de la organizaci√≥n (CloudAPI)
  # ... (Tareas de obtenci√≥n y validaci√≥n del ID de Org) ...
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs?filter=name=={{ vcd.orgFullName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: org_check
  delegate_to: localhost
  connection: local

- name: Extraer ID de la organizaci√≥n
  ansible.builtin.set_fact:
    org_id: "{{ org_check.json['values'][0]['id'] if (org_check.json['values'] | length > 0) else '' }}"
  delegate_to: localhost
  connection: local

- name: Validar existencia de la organizaci√≥n
  ansible.builtin.fail:
    msg: "‚ùå La organizaci√≥n '{{ vcd.orgFullName }}' no existe. Debe ser creada previamente."
  when: org_id == ''
  delegate_to: localhost
  connection: local

# ... (Tareas de resoluci√≥n de Provider VDC, Network Pool, Storage Policy, Compute Policy) ...
- name: Obtener todos los Provider VDCs (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/providerVdcs"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: provider_check
  delegate_to: localhost
  connection: local

- name: Buscar Provider VDC por prefijo regional
  ansible.builtin.set_fact:
    provider_match: >-
      {%
        set p = (
          provider_check.json['values']
          | selectattr('name', 'search', '^' ~ locationPrefix)
          | list
        )
      %}{{ {'name': p[0].name, 'id': p[0].id} if p | length == 1 else {} }}
  when: provider_check.json['values'] is defined and (provider_check.json['values'] | length > 0)
  delegate_to: localhost
  connection: local

- name: Validar Provider VDC encontrado
  ansible.builtin.fail:
    msg: "‚ùå No se encontr√≥ ning√∫n Provider VDC que comience con '{{ locationPrefix }}'."
  when: provider_match == {}
  delegate_to: localhost
  connection: local

- name: Obtener todos los Network Pools (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/networkPools/networkPoolSummaries"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: network_check
  delegate_to: localhost
  connection: local

- name: Buscar Network Pool por prefijo regional
  ansible.builtin.set_fact:
    network_match: >-
      {%
        set n = (
          network_check.json['values']
          | selectattr('name', 'search', '^' ~ locationPrefix)
          | list
        )
      %}{{ {'name': n[0].name, 'id': n[0].id} if n | length == 1 else {} }}
  when: network_check.json['values'] | length > 0
  delegate_to: localhost
  connection: local

- name: Validar Network Pool encontrado
  ansible.builtin.fail:
    msg: >-
      ‚ùå No se encontr√≥ ning√∫n Network Pool con prefijo '{{ locationPrefix }}'.
  when: network_match == {}
  delegate_to: localhost
  connection: local

- name: Obtener todos los Storage Profiles (Policies) (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/pvdcStoragePolicies"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: storage_check
  delegate_to: localhost
  connection: local

- name: Buscar Storage Policy por Provider VDC
  ansible.builtin.set_fact:
    storage_match: >-
      {%
        set s = (
          storage_check.json['values']
          | selectattr('providerVdcRef.name', 'equalto', provider_match.name)
          | selectattr('isEnabled', 'equalto', true)
          | selectattr('totalCapacityMb', '>', 0)
          | list
        )
      %}{{ {'name': s[0].name, 'id': s[0].id} if s | length > 0 else {} }}
  when: storage_check.json['values'] | length > 0
  delegate_to: localhost
  connection: local

- name: Validar Storage Profile encontrado
  ansible.builtin.fail:
    msg: "‚ùå No se encontr√≥ Storage Policy asociada al Provider '{{ provider_match.name }}'."
  when: storage_match == {}
  delegate_to: localhost
  connection: local

- name: Obtener Compute Policy por nombre (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/2.0.0/vdcComputePolicies?filter=name=={{ locationPrefix }}*"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: compute_policy_check
  delegate_to: localhost
  connection: local

- name: Buscar Placement Policy asociada al PVDC y seleccionarla
  ansible.builtin.set_fact:
    compute_match: "{{ compute_policy_check.json['values'] | selectattr('isSizingOnly', 'equalto', false) | selectattr('pvdcId', 'equalto', provider_match.id) | list | first | default({}) }}"
  when: compute_policy_check.json['values'] is defined and (compute_policy_check.json['values'] | length > 0)
  delegate_to: localhost
  connection: local

- name: Validar Placement Policy encontrada
  ansible.builtin.fail:
    msg: "‚ùå No se encontr√≥ ninguna Placement Policy ('isSizingOnly': false) asociada al Provider VDC '{{ provider_match.name }}' ({{ provider_match.id }})."
  when: compute_match == {}
  delegate_to: localhost
  connection: local

- name: Mostrar componentes detectados
  ansible.builtin.debug:
    msg:
      - "‚úÖ Provider VDC: {{ provider_match.name | default('No definido') }} ({{ provider_match.id | default('No definido') }})"
      - "‚úÖ Network Pool: {{ network_match.name | default('No definido') }} ({{ network_match.id | default('No definido') }})"
      - "‚úÖ Storage Profile: {{ storage_match.name | default('No definido') }} ({{ storage_match.id | default('No definido') }})"
      - "‚úÖ Compute Policy: {{ compute_match.name | default('No definido') }} ({{ compute_match.id | default('No definido') }})"
  delegate_to: localhost
  connection: local

# ===========================================================
# 3. L√ìGICA DE CREACI√ìN Y PRE-EJECUCI√ìN
# ===========================================================
- name: Verificar si el Org VDC ya existe por nombre
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/vdcs?filter=name=={{ vcd.orgVdcName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: vdc_check
  delegate_to: localhost
  connection: local

- name: Determinar si el Org VDC ya existe
  ansible.builtin.set_fact:
    vdc_exists: "{{ vdc_check.json['values'] | length > 0 }}"
  delegate_to: localhost
  connection: local

- name: Determinar modelo de asignaci√≥n (basado en vcd.trial)
  ansible.builtin.set_fact:
    allocation_model: >-
      {% if vcd.trial | bool %}
      PayAsYouGo
      {% else %}
      AllocationPool
      {% endif %}
  delegate_to: localhost
  connection: local

- name: Mostrar modelo de asignaci√≥n seleccionado
  ansible.builtin.debug:
    msg: "‚öôÔ∏è Modo de asignaci√≥n seleccionado: {{ allocation_model }}"
  delegate_to: localhost
  connection: local

# -----------------------------------------------------------
# BLOQUE 1: PROCESO PRINCIPAL DE APROVISIONAMIENTO (Org VDC)
# (Corresponde a Stage 1: Create Organization)
# -----------------------------------------------------------
- name: Proceso principal de aprovisionamiento de VDC con Rollback
  ansible.builtin.block:
    # ===========================================================
    # 4. EJECUCI√ìN PRINCIPAL (PowerCLI - CREACI√ìN Y METADATOS)
    # ===========================================================
    - name: Ejecutar PowerCLI en Windows (Crea el Org VDC y aplica Metadatos)
      ansible.builtin.win_shell: >
        & 'D:\Users\Jeferson Diaz\Documents\g6\Ansible\orgvcd.ps1' -AllocationModel '{{allocation_model | trim}}' -Server '{{ vcd.host }}' -Username '{{ vcd.user }}' -Password '{{ vcd.password }}' -OrgName '{{ vcd.orgFullName }}' -VdcName '{{ vcd.orgVdcName }}' -ProvName '{{ provider_match.name | default('') }}' -CpName '{{ compute_match.name | default('') }}' -SpName '{{ storage_match.name | default('') }}' -NpName '{{ network_match.name | default('') }}' -CpuAllocation {{ vcd.cpuQuota | trim }} -MemoryAllocation {{ vcd.memoryQuota | trim }} -StorageAllocation {{ vcd.storageQuota | trim }} -Description 'Organizaci√≥n {{ vcd.orgFullName }} - creado por AWX' -IsTrialMode {{ vcd.trial | bool | ternary('$True', '$False') }}
      vars:
        ansible_connection: winrm
        ansible_host: "100.66.2.151"
        ansible_port: 5985
        ansible_user: "jeferson diaz"
        ansible_password: "Zero.eg9olj12*"
        ansible_winrm_transport: basic
        ansible_winrm_server_cert_validation: ignore
      register: script_result

    # ===========================================================
    # 5. EXTRACCI√ìN Y VALIDACI√ìN DEL ID
    # ===========================================================
    - name: Extraer ID del Org VDC reci√©n creado o existente
      ansible.builtin.set_fact:
        created_vdc_id: >-
          {{ ((script_result.stdout_lines | select('match', '^VDC_ID_CREATED:') | list) | first) | default('') | split(':') | last | default('') | trim }}
      delegate_to: localhost
      connection: local

    - name: Validar que se encontr√≥ el VDC ID (Punto de fallo cr√≠tico)
      ansible.builtin.fail:
        msg: "‚ùå ERROR: No se pudo obtener el ID del VDC (VDC_ID_CREATED) de la salida de PowerCLI. Activando el Rollback."
      when: created_vdc_id == ''
      delegate_to: localhost
      connection: local

    # ===========================================================
    # 6. MOSTRAR RESULTADO FINAL (√âxito)
    # ===========================================================
    - name: Mostrar mensaje de confirmaci√≥n de Metadatos
      ansible.builtin.debug:
        msg: "‚úÖ Metadato 'isTrialMode' ({{ vcd.trial | bool }}) aplicado exitosamente por el script PowerCLI."
      delegate_to: localhost
      connection: local

    - name: Mostrar resultado del script PowerCLI (VDC)
      ansible.builtin.debug:
        msg:
          - "‚úÖ Ejecuci√≥n VDC completada en PowerCLI"
          - "üìú Salida:"
          - "{{ script_result.stdout_lines }}"
      delegate_to: localhost
      connection: local

  # -----------------------------------------------------------
  # SECCI√ìN DE RESCATE (ROLLBACK VDC)
  # -----------------------------------------------------------
  rescue:
    - name: ‚ö†Ô∏è INICIANDO ROLLBACK VDC ‚ö†Ô∏è - Eliminando VDC parcialmente creado
      ansible.builtin.debug:
        msg: "Rollback activado debido a un fallo en el bloque de aprovisionamiento del VDC."
      delegate_to: localhost
      connection: local

    - name: Eliminar Org VDC usando el ID extra√≠do (SI EXISTE)
      ansible.builtin.win_shell: >
        & 'D:\Users\Jeferson Diaz\Documents\g6\Ansible\delete_orgvdc.ps1' -VdcId '{{ created_vdc_id }}' -Server '{{ vcd.host }}' -Username '{{ vcd.user }}' -Password '{{ vcd.password }}'
      vars:
        ansible_connection: winrm
        ansible_host: "100.66.2.151"
        ansible_port: 5985
        ansible_user: "jeferson diaz"
        ansible_password: "Zero.eg9olj12*"
        ansible_winrm_transport: basic
        ansible_winrm_server_cert_validation: ignore
      # Solo intenta eliminar si el ID fue extra√≠do
      when: created_vdc_id is defined and created_vdc_id != ''
      ignore_errors: true

    - name: Notificar Fallo Cr√≠tico despu√©s del Rollback VDC
      ansible.builtin.fail:
        msg: "‚ùå PROVISI√ìN VDC FALLIDA. Se intent√≥ la limpieza/Rollback del VDC con ID: {{ created_vdc_id | default('N/A') }}"
      delegate_to: localhost
      connection: local
