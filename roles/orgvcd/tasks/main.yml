---
- name: Proceso Completo de CreaciÃ³n de Org VDC y AplicaciÃ³n de Metadatos
  # Nota: El host debe ser la mÃ¡quina Windows donde se ejecutarÃ¡ PowerCLI.
  # Las tareas que usan 'delegate_to: localhost' se ejecutan en el Execution Node de AWX
  hosts: vcd_winrm_node
  gather_facts: false

# ===========================================================
# 1. EXTRACCIÃ“N Y VALIDACIÃ“N PRELIMINAR (CloudAPI)
# ===========================================================
- name: Extraer prefijo del Org VDC para bÃºsqueda regional
  ansible.builtin.set_fact:
    locationPrefix: "{{ vcd.orgVdcName.split('-')[0] }}"
  delegate_to: localhost
  connection: local

- name: Obtener ID de la organizaciÃ³n (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/orgs?filter=name=={{ vcd.orgFullName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: org_check
  delegate_to: localhost
  connection: local

- name: Extraer ID de la organizaciÃ³n
  ansible.builtin.set_fact:
    org_id: "{{ org_check.json['values'][0]['id'] if (org_check.json['values'] | length > 0) else '' }}"
  delegate_to: localhost
  connection: local

- name: Validar existencia de la organizaciÃ³n
  ansible.builtin.fail:
    msg: "âŒ La organizaciÃ³n '{{ vcd.orgFullName }}' no existe. Debe ser creada previamente."
  when: org_id == ''
  delegate_to: localhost
  connection: local

# ===========================================================
# 2. RESOLVER COMPONENTES NECESARIOS (Provider VDC, Network, Storage, Compute)
# ===========================================================
- name: Obtener todos los Provider VDCs (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/providerVdcs"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: provider_check
  delegate_to: localhost
  connection: local

- name: Buscar Provider VDC por prefijo regional
  ansible.builtin.set_fact:
    provider_match: >-
      {%
        set p = (
          provider_check.json['values']
          | selectattr('name', 'search', '^' ~ locationPrefix)
          | list
        )
      %}{{ {'name': p[0].name, 'id': p[0].id} if p | length == 1 else {} }}
  when: provider_check.json['values'] is defined and (provider_check.json['values'] | length > 0)
  delegate_to: localhost
  connection: local

- name: Validar Provider VDC encontrado
  ansible.builtin.fail:
    msg: "âŒ No se encontrÃ³ ningÃºn Provider VDC que comience con '{{ locationPrefix }}'."
  when: provider_match == {}
  delegate_to: localhost
  connection: local

- name: Obtener todos los Network Pools (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/networkPools/networkPoolSummaries"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: network_check
  delegate_to: localhost
  connection: local

- name: Buscar Network Pool por prefijo regional
  ansible.builtin.set_fact:
    network_match: >-
      {%
        set n = (
        network_check.json['values']
        | selectattr('name', 'search', '^' ~ locationPrefix)
        | list
        )
      %}{{ {'name': n[0].name, 'id': n[0].id} if n | length == 1 else {} }}
  when: network_check.json['values'] | length > 0
  delegate_to: localhost
  connection: local

- name: Validar Network Pool encontrado
  ansible.builtin.fail:
    msg: >-
      âŒ No se encontrÃ³ ningÃºn Network Pool con prefijo '{{ locationPrefix }}'.
  when: network_match == {}
  delegate_to: localhost
  connection: local

- name: Obtener todos los Storage Profiles (Policies) (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/pvdcStoragePolicies"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: storage_check
  delegate_to: localhost
  connection: local

- name: Buscar Storage Policy por Provider VDC
  ansible.builtin.set_fact:
    storage_match: >-
      {%
        set s = (
          storage_check.json['values']
          | selectattr('providerVdcRef.name', 'equalto', provider_match.name)
          | selectattr('isEnabled', 'equalto', true)
          | selectattr('totalCapacityMb', '>', 0)
          | list
        )
      %}{{ {'name': s[0].name, 'id': s[0].id} if s | length > 0 else {} }}
  when: storage_check.json['values'] | length > 0
  delegate_to: localhost
  connection: local

- name: Validar Storage Profile encontrado
  ansible.builtin.fail:
    msg: "âŒ No se encontrÃ³ Storage Policy asociada al Provider '{{ provider_match.name }}'."
  when: storage_match == {}
  delegate_to: localhost
  connection: local

- name: Obtener Compute Policy por nombre (CloudAPI)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/2.0.0/vdcComputePolicies?filter=name=={{ locationPrefix }}*"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: compute_policy_check
  delegate_to: localhost
  connection: local

- name: Buscar Placement Policy asociada al PVDC y seleccionarla
  ansible.builtin.set_fact:
    compute_match: "{{ compute_policy_check.json['values'] | selectattr('isSizingOnly', 'equalto', false) | selectattr('pvdcId', 'equalto', provider_match.id) | list | first | default({}) }}"
  when: compute_policy_check.json['values'] is defined and (compute_policy_check.json['values'] | length > 0)
  delegate_to: localhost
  connection: local

- name: Validar Placement Policy encontrada
  ansible.builtin.fail:
    msg: "âŒ No se encontrÃ³ ninguna Placement Policy ('isSizingOnly': false) asociada al Provider VDC '{{ provider_match.name }}' ({{ provider_match.id }})."
  when: compute_match == {}
  delegate_to: localhost
  connection: local

- name: Mostrar componentes detectados
  ansible.builtin.debug:
    msg:
      - "âœ… Provider VDC: {{ provider_match.name | default('No definido') }} ({{ provider_match.id | default('No definido') }})"
      - "âœ… Network Pool: {{ network_match.name | default('No definido') }} ({{ network_match.id | default('No definido') }})"
      - "âœ… Storage Profile: {{ storage_match.name | default('No definido') }} ({{ storage_match.id | default('No definido') }})"
      - "âœ… Compute Policy: {{ compute_match.name | default('No definido') }} ({{ compute_match.id | default('No definido') }})"
  delegate_to: localhost
  connection: local

# ===========================================================
# 3. LÃ“GICA DE CREACIÃ“N Y PRE-EJECUCIÃ“N
# ===========================================================
- name: Verificar si el Org VDC ya existe por nombre
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/vdcs?filter=name=={{ vcd.orgVdcName }}"
    method: GET
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
    return_content: yes
    validate_certs: false
  register: vdc_check
  delegate_to: localhost
  connection: local

- name: Determinar si el Org VDC ya existe
  ansible.builtin.set_fact:
    vdc_exists: "{{ vdc_check.json['values'] | length > 0 }}"
  delegate_to: localhost
  connection: local

- name: Determinar modelo de asignaciÃ³n (basado en vcd.trial)
  ansible.builtin.set_fact:
    allocation_model: >-
      {% if vcd.trial | bool %}
      PayAsYouGo
      {% else %}
      AllocationPool
      {% endif %}
  delegate_to: localhost
  connection: local

- name: Mostrar modelo de asignaciÃ³n seleccionado
  ansible.builtin.debug:
    msg: "âš™ï¸ Modo de asignaciÃ³n seleccionado: {{ allocation_model }}"
  delegate_to: localhost
  connection: local

# ===========================================================
# 4. EJECUCIÃ“N PRINCIPAL (PowerCLI)
# ===========================================================
- name:
    Ejecutar PowerCLI en Windows (Crea el Org VDC)
    # Nota: AsegÃºrate de que el script 'orgvcd.ps1' tenga la lÃ­nea 'Write-Host "VDC_ID_CREATED:$($newVdc.Id)"'
    # para que la siguiente tarea pueda extraer el ID.
  ansible.builtin.win_shell: >
    powershell.exe -ExecutionPolicy Bypass -File "D:\Users\Jeferson Diaz\Documents\g6\Ansible\orgvcd.ps1"
    -AllocationModel "{{allocation_model}}"
    -Server "{{ vcd.host }}"
    -Username "{{ vcd.user }}"
    -Password "{{ vcd.password }}"
    -OrgName "{{ vcd.orgFullName }}"
    -VdcName "{{ vcd.orgVdcName }}"
    -ProvName "{{ provider_match.name | default('') }}"
    -CpName "{{ compute_match.name | default('') }}"
    -SpName "{{ storage_match.name | default('') }}"
    -NpName "{{ network_match.name | default('') }}"
    -CpuAllocation {{ vcd.cpuQuota }}
    -MemoryAllocation {{ vcd.memoryQuota }}
    -StorageAllocation {{ vcd.storageQuota }}
    -Description "OrganizaciÃ³n {{ vcd.orgFullName }} - creado por AWX"
  vars:
    ansible_connection: winrm
    ansible_host: "100.66.2.151"
    ansible_port: 5985
    ansible_user: "jeferson diaz"
    ansible_password: "Zero.eg9olj12*"
    ansible_winrm_transport: basic
    ansible_winrm_server_cert_validation: ignore
  register: script_result

# ===========================================================
# 5. APLICAR METADATOS DE "TRIAL MODE" (CloudAPI POST)
# ===========================================================
- name: Extraer ID del Org VDC reciÃ©n creado
  ansible.builtin.set_fact:
    # Usar regex para buscar la lÃ­nea "VDC_ID_CREATED:urn:vcd:vdc:..."
    created_vdc_id: "{{ script_result.stdout | regex_search('VDC_ID_CREATED:(urn:vcd:vdc:[^\\n]+)', '\\1') | first }}"
  when: not vdc_exists # Solo si el VDC fue creado
  delegate_to: localhost
  connection: local

- name: Construir Payload JSON para actualizar Metadatos
  ansible.builtin.set_fact:
    metadata_payload:
      key: "isTrialMode" # Usar una clave consistente con la VRO Action original
      typedValue:
        _type: "MetadataBooleanValue"
        value: "{{ vcd.trial | bool }}"
  when: not vdc_exists and created_vdc_id is defined and created_vdc_id != ''
  delegate_to: localhost
  connection: local

- name: Aplicar Metadato "isTrialMode" al Org VDC (CloudAPI POST)
  ansible.builtin.uri:
    url: "{{ vcd.host }}/cloudapi/1.0.0/vdcs/{{ created_vdc_id }}/metadata"
    method: POST
    headers:
      Accept: "application/json;version={{ vcd.api_version }}"
      Authorization: "Bearer {{ vcd.access_token }}"
      Content-Type: "application/json"
    body: "{{ metadata_payload | to_json }}"
    body_format: json
    status_code: 202 # Tarea asÃ­ncrona (202 Accepted)
    validate_certs: false
  when: not vdc_exists and created_vdc_id is defined and created_vdc_id != ''
  register: metadata_task
  delegate_to: localhost
  connection: local

- name: Mostrar mensaje de metadato aplicado
  ansible.builtin.debug:
    msg: "âœ… Metadato 'isTrialMode' ({{ vcd.trial | bool }}) aplicado al OrgVDC."
  when: metadata_task is defined and metadata_task.status == 202
  delegate_to: localhost
  connection: local
# ===========================================================
# 6. MOSTRAR RESULTADO FINAL
# ===========================================================
- name: Mostrar resultado del script PowerCLI
  ansible.builtin.debug:
    msg:
      - "âœ… EjecuciÃ³n completada en PowerCLI"
      - "ðŸ“œ Salida:"
      - "{{ script_result.stdout_lines }}"
